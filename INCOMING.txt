Selected Files Directory Structure:

â””â”€â”€ ./
    â””â”€â”€ test-indonesia-map
        â””â”€â”€ regional_app
            â”œâ”€â”€ static
            â”‚   â”œâ”€â”€ css
            â”‚   â”‚   â””â”€â”€ styles.css
            â”‚   â””â”€â”€ js
            â”‚       â”œâ”€â”€ api.js
            â”‚       â”œâ”€â”€ app.js
            â”‚       â”œâ”€â”€ choroplethRenderer.js
            â”‚       â”œâ”€â”€ config.js
            â”‚       â”œâ”€â”€ mapRenderer.js
            â”‚       â”œâ”€â”€ navigation.js
            â”‚       â””â”€â”€ patternRenderer.js
            â”œâ”€â”€ templates
            â”‚   â””â”€â”€ index.html
            â””â”€â”€ app.py



--- test-indonesia-map/regional_app/static/js/api.js ---

export async function fetchApiData(endpoint) {
    const res = await fetch(endpoint);
    if (!res.ok) throw new Error(`Gagal mengambil data dari ${endpoint}`);
    return res.json();
}

export async function fetchGeoJSON(url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error('Gagal memuat file peta.');
    return res.json();
}


--- test-indonesia-map/regional_app/static/js/mapRenderer.js ---

// Deprecated: split into navigation.js, choroplethRenderer.js, patternRenderer.js
export { attachNavigationEnhancements } from './navigation.js';
export { renderChoroplethMap } from './choroplethRenderer.js';
export { renderPatternMap } from './patternRenderer.js';


--- test-indonesia-map/regional_app/static/js/navigation.js ---

export function attachNavigationEnhancements(chart) {
    const mv = chart.mapView;
    if (!mv) return;
    const initialCenter = mv.center && mv.center.slice ? mv.center.slice() : null;
    const initialZoom = mv.zoom;
    chart.renderer.button('ðŸ”„ Reset Zoom', 10, 55, function () {
        if (initialCenter != null && typeof initialZoom === 'number') {
            mv.setView(initialCenter, initialZoom, { duration: 600, easing: 'easeOutCubic' });
        }
    }, {
        fill: 'rgba(102,126,234,0.95)',
        stroke: '#5568d3',
        'stroke-width': 2,
        r: 8,
        style: { color: '#fff', fontWeight: '600', fontSize: '0.875rem' }
    }, {
        fill: '#5568d3',
        stroke: '#4a5bbd',
        'stroke-width': 2,
        r: 8,
        style: { color: '#fff', fontWeight: '600' }
    }).attr({ zIndex: 7 }).add();
    chart.container?.addEventListener('dblclick', () => {
        if (initialCenter != null && typeof initialZoom === 'number') {
            mv.setView(initialCenter, initialZoom, { duration: 600, easing: 'easeOutCubic' });
        }
    });
}


--- test-indonesia-map/regional_app/static/js/patternRenderer.js ---

import { appColors } from './config.js';
import { attachNavigationEnhancements } from './navigation.js';

export function renderPatternMap({
    mapData,
    currentApiData,
    config,
    metricDetails,
    reverseNameMapping,
    selectedMetric,
    datasetKey,
    containerId = 'container'
}) {
    if (!currentApiData || !mapData) return;

    // Build mapping appName -> numeric category index for dataClasses legend
    const appIndexMap = {};
    let nextIndex = 0;

    const chartData = currentApiData.map(item => {
        const appName = item[selectedMetric];
        const provinceName = item[config.keyColumn];
        const geoName = reverseNameMapping[provinceName] || provinceName;
        const isAcehFinancial = datasetKey === 'financial' && (provinceName === 'Aceh' || geoName === 'Aceh');

        if (appName && !isAcehFinancial) {
            if (!(appName in appIndexMap)) appIndexMap[appName] = nextIndex++;
            return {
                name: geoName,
                appName,
                value: appIndexMap[appName],
                logoUrl: `/static/logos/${appName}.png`
            };
        }
        // Aceh (financial) gets sentinel -1 to appear in legend; other missing remain null
        return { name: geoName, appName: null, value: isAcehFinancial ? -1 : null };
    });

    // Generate dataClasses for legend (one per fintech app)
    const dataClasses = Object.entries(appIndexMap).map(([appName, idx]) => ({
        from: idx,
        to: idx,
        color: appColors[appName] || '#757575',
        name: appName
    }));

    if (datasetKey === 'financial') {
        // Legend item for Aceh only
        dataClasses.push({
            from: -1,
            to: -1,
            color: '#E0E0E0',
            name: 'Data Tidak Tersedia'
        });
    }

    Highcharts.mapChart(containerId, {
        chart: {
            map: mapData,
            backgroundColor: '#ffffff',
            style: { fontFamily: 'Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif' },
            events: { load: function () { attachNavigationEnhancements(this); } }
        },
        exporting: {
            buttons: { contextButton: { align: 'right', verticalAlign: 'bottom', y: -10 } }
        },
        title: {
            text: `${config.titlePrefix}: ${metricDetails.label}`,
            align: 'right',
            style: { fontSize: '1.5rem', fontWeight: '700', color: '#2d3748' }
        },
        subtitle: {
            text: 'Sumber data: Gelarrasa (Simulasi)',
            align: 'right',
            style: { fontSize: '0.95rem', color: '#718096' }
        },
        legend: {
            // Hapus title untuk tampilan lebih bersih
            layout: 'horizontal',
            align: 'center',
            verticalAlign: 'bottom',
            floating: false,
            itemStyle: { fontSize: '0.75rem' },
            symbolRadius: 6,
            padding: 8,
            backgroundColor: 'rgba(255,255,255,0.85)',
            borderRadius: 8
        },
        mapNavigation: {
            enabled: true,
            buttonOptions: {
                verticalAlign: 'bottom',
                theme: {
                    fill: 'rgba(255,255,255,0.9)',
                    stroke: '#e2e8f0',
                    'stroke-width': 2,
                    r: 8,
                    style: { color: '#2d3748', fontWeight: '600' },
                    states: {
                        hover: { fill: '#667eea', style: { color: '#ffffff' } },
                        select: { fill: '#667eea', style: { color: '#ffffff' } }
                    }
                }
            }
        },
        plotOptions: {
            series: {
                cursor: 'pointer',
                point: {
                    events: {
                        click: function () {
                            const mv = this.series.chart.mapView;
                            if (!mv) return;
                            if (typeof this.zoomTo === 'function') { this.zoomTo(60, { duration: 800, easing: 'easeOutCubic' }); return; }
                            if (this.bounds) mv.fitToBounds(this.bounds, { padding: 60, animation: { duration: 800, easing: 'easeOutCubic' } });
                        }
                    }
                }
            }
        },
        colorAxis: {
            // Use dataClasses for categorical legend
            dataClasses,
            nullColor: '#E0E0E0'
        },
        tooltip: {
            useHTML: true,
            backgroundColor: 'rgba(255,255,255,0.98)',
            borderColor: '#e2e8f0',
            borderRadius: 12,
            borderWidth: 1,
            style: { fontSize: '0.95rem' },
            formatter: function () {
                const geoProvinceName = this.point.name;
                const csvProvinceName = reverseNameMapping[geoProvinceName] || geoProvinceName;
                const provinceData = currentApiData.find(d => d[config.keyColumn] === csvProvinceName);
                if (!provinceData) return `<b>${geoProvinceName}</b><br/><em style="color:#999;">Data tidak tersedia</em>`;
                const appName = provinceData[selectedMetric];
                if (!appName) {
                    return `<div style="padding:12px;min-width:220px;font-family:Inter,sans-serif;">
						<div style="font-weight:700;margin-bottom:10px;font-size:1.05rem;color:#2d3748;">${provinceData[config.keyColumn]}</div>
						<div style="color:#a0aec0;font-size:0.875rem;">Data tidak tersedia</div>
					</div>`;
                }
                const percentage = provinceData.fintech_percentage || 0;
                const logoUrl = `/static/logos/${appName}.png`;
                return `<div style="padding:12px;min-width:220px;font-family:Inter,sans-serif;">
					<div style="font-weight:700;margin-bottom:10px;font-size:1.05rem;color:#2d3748;">${provinceData[config.keyColumn]}</div>
					<div style="display:flex;align-items:center;gap:12px;">
						<img src="${logoUrl}" style="width:48px;height:48px;object-fit:contain;background:#fff;border:2px solid #e2e8f0;border-radius:10px;padding:6px;" onerror="this.style.display='none'" />
						<div>
							<div style="font-weight:600;color:#2d3748;font-size:1rem;">${appName}</div>
							<div style="color:#718096;font-size:0.875rem;margin-top:2px;">Pengguna: <b style="color:#667eea;">${percentage}%</b></div>
						</div>
					</div>
				</div>`;
            }
        },
        series: [{
            data: chartData,
            joinBy: ['PROVINSI', 'name'],
            name: metricDetails.label,
            nullColor: '#E0E0E0',
            dataLabels: { enabled: false },
            states: { hover: { brightness: 0.15, borderColor: '#667eea', borderWidth: 2.5 } },
            borderColor: '#FFFFFF',
            borderWidth: 1.5
        }]
    });
}


--- test-indonesia-map/regional_app/static/js/config.js ---

export const GEOJSON_URL = '/static/indonesia-38-provinsi.geojson';

export const provinceNameMapping = {
    "Nanggroe Aceh Darusalam": "Aceh",
    "DI Yogyakarta": "Daerah Istimewa Yogyakarta",
    "DKI Jakarta": "DKI Jakarta"
};

export const reverseNameMapping = Object.fromEntries(
    Object.entries(provinceNameMapping).map(([csv, geo]) => [geo, csv])
);

// Colors for fintech app logos (pattern map)
export const appColors = {
    Dana: '#118EEA',
    OVO: '#4C3494',
    GoPay: '#00AA13',
    ShopeePay: '#FF6A3D',
    LinkAja: '#C92A2A',
    Kredivo: '#B33A1C',
    Akulaku: '#FF866B'
};

export const datasetsConfig = {
    regional: {
        endpoint: '/api/data',
        titlePrefix: 'Indikator Ekonomi Regional',
        keyColumn: 'provinsi',
        metrics: {
            outstanding_pinjaman_miliar: { label: 'Outstanding Pinjaman (Rp miliar)', vizType: 'choropleth', type: 'logarithmic', minColor: '#FFF5E6', maxColor: '#FF6B35' },
            dana_diberikan_miliar: { label: 'Jumlah Dana Diberikan (Rp miliar)', vizType: 'choropleth', type: 'logarithmic', minColor: '#E8F5E9', maxColor: '#2E7D32' },
            rekening_penerima_aktif: { label: 'Rekening Penerima Pinjaman Aktif', vizType: 'choropleth', type: 'logarithmic', minColor: '#F0F9FF', maxColor: '#0C4A6E' },
            twp_90: { label: 'TWP 90 (%)', vizType: 'choropleth', type: 'linear', minColor: '#FCE4EC', maxColor: '#C62828' },
            pdrb_ribu_rp: { label: 'PDRB (Ribu Rp)', vizType: 'choropleth', type: 'logarithmic', minColor: '#5DE2E7', maxColor: '#6A0DAD' },
            urbanisasi_persen: { label: 'Tingkat Urbanisasi (%)', vizType: 'choropleth', type: 'linear', minColor: '#FFF3E0', maxColor: '#EF6C00' },
            jumlah_penduduk_ribu: { label: 'Jumlah Penduduk (Ribu Jiwa)', vizType: 'choropleth', type: 'logarithmic', minColor: '#E0F2F1', maxColor: '#00695C' }
        }
    },
    financial: {
        endpoint: '/api/financial-profile',
        titlePrefix: 'Profil Finansial Gen Z',
        keyColumn: 'provinsi',
        metrics: {
            financial_balance: {
                label: 'Status Keuangan (Surplus/Defisit)',
                vizType: 'choropleth',
                dataClasses: [
                    { to: -0.01, color: '#C62828', name: 'Defisit' },
                    { from: 0, color: '#1565C0', name: 'Surplus' }
                ],
                nullColor: '#E0E0E0'
            },
            avg_anxiety_score: { label: 'Rata-rata Skor Kecemasan Finansial', vizType: 'choropleth', type: 'linear', minColor: '#FCE4EC', maxColor: '#C62828' },
            avg_digital_time: { label: 'Rata-rata Waktu Digital Harian (Jam)', vizType: 'choropleth', type: 'linear', minColor: '#E3F2FD', maxColor: '#1565C0' },
            mode_fintech_app: { label: 'Fintech Populer (Logo)', vizType: 'pattern' }
        }
    }
};


--- test-indonesia-map/regional_app/static/js/choroplethRenderer.js ---

import { attachNavigationEnhancements } from './navigation.js';

export function renderChoroplethMap({
    mapData,
    currentApiData,
    config,
    metricDetails,
    reverseNameMapping,
    selectedMetric,
    datasetKey,
    containerId = 'container'
}) {
    if (!currentApiData || !mapData) return;
    const allProvinces = mapData.features.map(f => f.properties.PROVINSI);
    const chartData = allProvinces.map(geoName => {
        const csvProvinceName = reverseNameMapping[geoName] || geoName;
        const item = currentApiData.find(d => d[config.keyColumn] === csvProvinceName);
        let value = null;
        if (item) value = item[selectedMetric] != null ? parseFloat(item[selectedMetric]) : null;

        const isAcehFinancial = datasetKey === 'financial' && (geoName === 'Aceh' || csvProvinceName === 'Aceh');
        const isFinancialBalance = datasetKey === 'financial' && selectedMetric === 'financial_balance';

        // Aceh only gets sentinel -1 for Status Keuangan to appear in legend
        const finalValue = (isAcehFinancial && isFinancialBalance) ? -1 : (isAcehFinancial ? null : value);

        return {
            name: geoName,
            value: finalValue,
            color: (finalValue === null || finalValue === -1) ? '#E0E0E0' : undefined
        };
    });
    const colorAxisOptions = metricDetails.dataClasses
        ? (() => {
            const isFinancialBalance = datasetKey === 'financial' && selectedMetric === 'financial_balance';
            const dc = [...metricDetails.dataClasses];
            if (isFinancialBalance) {
                dc.push({ from: -1, to: -1, color: '#E0E0E0', name: 'Data Tidak Tersedia' });
            }
            return { dataClasses: dc };
        })()
        : {
            type: metricDetails.type,
            // Override khusus per metrik
            ...(selectedMetric === 'pdrb_ribu_rp'
                ? { min: 10000, max: 1000000 }
                : selectedMetric === 'rekening_penerima_aktif'
                    ? { min: 1000, max: 10000000 }
                    : selectedMetric === 'jumlah_penduduk_ribu'
                        ? { min: 100, max: 100000 }
                        : { min: metricDetails.type === 'logarithmic' ? 1 : null }),
            minColor: metricDetails.minColor,
            maxColor: metricDetails.maxColor,
            labels: {
                formatter: function () { return this.value ? this.value.toLocaleString('id-ID') : 'N/A'; },
                style: { fontSize: '0.875rem', color: '#4a5568' }
            }
        };

    Highcharts.mapChart(containerId, {
        chart: {
            map: mapData,
            backgroundColor: '#ffffff',
            style: { fontFamily: 'Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif' },
            events: { load: function () { attachNavigationEnhancements(this); } }
        },
        exporting: { buttons: { contextButton: { align: 'right', verticalAlign: 'bottom', y: -10 } } },
        title: {
            text: `${config.titlePrefix}: ${metricDetails.label}`,
            align: 'right',
            style: { fontSize: '1.5rem', fontWeight: '700', color: '#2d3748' }
        },
        mapNavigation: {
            enabled: true,
            buttonOptions: {
                verticalAlign: 'bottom',
                theme: {
                    fill: 'rgba(255,255,255,0.9)',
                    stroke: '#e2e8f0',
                    'stroke-width': 2,
                    r: 8,
                    style: { color: '#2d3748', fontWeight: '600' },
                    states: {
                        hover: { fill: '#667eea', style: { color: '#ffffff' } },
                        select: { fill: '#667eea', style: { color: '#ffffff' } }
                    }
                }
            }
        },
        plotOptions: {
            series: {
                cursor: 'pointer',
                point: {
                    events: {
                        click: function () {
                            const mv = this.series.chart.mapView;
                            if (!mv) return;
                            if (typeof this.zoomTo === 'function') { this.zoomTo(60, { duration: 1000, easing: 'easeOutCubic' }); return; }
                            if (this.bounds) mv.fitToBounds(this.bounds, { padding: 60, animation: { duration: 1000, easing: 'easeOutCubic' } });
                        }
                    }
                }
            }
        },
        colorAxis: colorAxisOptions,
        series: [{
            data: chartData,
            joinBy: ['PROVINSI', 'name'],
            name: metricDetails.label,
            nullColor: metricDetails.nullColor || '#E0E0E0',
            borderColor: '#ffffff',
            borderWidth: 1.5,
            states: { hover: { color: '#667eea', borderColor: '#ffffff', brightness: 0.1 } },
            tooltip: {
                headerFormat: '<span></span>',
                backgroundColor: 'rgba(255,255,255,0.98)',
                borderColor: '#e2e8f0',
                borderRadius: 12,
                borderWidth: 1,
                style: { fontSize: '0.95rem', fontWeight: '500' },
                pointFormatter: function () {
                    const geoProvinceName = this.name;
                    const csvProvinceName = reverseNameMapping[geoProvinceName] || geoProvinceName;
                    const provinceData = currentApiData.find(d => d[config.keyColumn] === csvProvinceName);
                    if (!provinceData || provinceData[selectedMetric] == null) return `<b>${geoProvinceName}</b><br/><em style="color:#999;">Data tidak tersedia</em>`;
                    let out = `<b>${provinceData[config.keyColumn]}</b><br/>`;
                    if (selectedMetric === 'financial_balance') {
                        const balance = provinceData.financial_balance;
                        const income = provinceData.avg_income;
                        const expense = provinceData.avg_expense;
                        const status = balance >= 0 ? '<span style="color:#1565C0;font-weight:bold;">Surplus</span>' : '<span style="color:#C62828;font-weight:bold;">Defisit</span>';
                        out += `Status Keuangan: ${status}<br/>--------------------<br/>Pendapatan: <b>Rp ${income?.toLocaleString('id-ID') || 'N/A'}</b><br/>Pengeluaran: <b>Rp ${expense?.toLocaleString('id-ID') || 'N/A'}</b>`;
                    } else {
                        const v = provinceData[selectedMetric];
                        const formatted = v != null ? parseFloat(v).toLocaleString('id-ID') : 'N/A';
                        let display = `<b>${formatted}</b>`;
                        if (['avg_income', 'avg_expense'].includes(selectedMetric)) display = `<b>Rp ${formatted}</b>`;
                        else if (selectedMetric === 'avg_digital_time') display = `<b>${formatted} jam</b>`;
                        out += `${metricDetails.label}: ${display}`;
                    }
                    return out;
                }
            }
        }]
    });
}


--- test-indonesia-map/regional_app/static/js/app.js ---

import { datasetsConfig, GEOJSON_URL, reverseNameMapping } from './config.js';
import { fetchApiData, fetchGeoJSON } from './api.js';
import { renderChoroplethMap } from './choroplethRenderer.js';
import { renderPatternMap } from './patternRenderer.js';

document.addEventListener('DOMContentLoaded', async function () {
    const datasetSelector = document.getElementById('dataset-selector');
    const metricSelector = document.getElementById('metric-selector');
    const container = document.getElementById('container');

    const state = { currentApiData: [], mapData: null };

    // --- Custom dropdown helpers ---
    function destroyEnhancedSelect(select) {
        const wrapper = select.closest('.select-wrapper');
        if (!wrapper) return;
        wrapper.classList.remove('open', 'is-enhanced');
        select.classList.remove('select-native-hidden');
        // Remove previous custom nodes if any
        wrapper.querySelectorAll('.custom-select, .select-menu').forEach(n => n.remove());
    }

    function enhanceSelect(select) {
        try {
            if (!select) return;
            const wrapper = select.closest('.select-wrapper');
            if (!wrapper) return;

            // If already enhanced, skip
            if (wrapper.classList.contains('is-enhanced')) return;

            wrapper.classList.add('is-enhanced');
            select.classList.add('select-native-hidden');

            const getSelectedText = () => {
                const opt = select.options[select.selectedIndex];
                return opt ? opt.textContent : 'Pilih';
            };

            // Trigger
            const trigger = document.createElement('button');
            trigger.type = 'button';
            trigger.className = 'custom-select';
            trigger.setAttribute('aria-haspopup', 'listbox');
            trigger.setAttribute('aria-expanded', 'false');
            trigger.innerHTML = `<span class="select-label">${getSelectedText()}</span><span class="select-caret"></span>`;
            wrapper.appendChild(trigger);

            // Menu
            const menu = document.createElement('div');
            menu.className = 'select-menu';
            menu.setAttribute('role', 'listbox');

            Array.from(select.options).forEach((opt, idx) => {
                const item = document.createElement('div');
                item.className = 'select-option';
                item.setAttribute('role', 'option');
                item.dataset.value = opt.value;
                if (opt.disabled) item.setAttribute('aria-disabled', 'true');
                if (idx === select.selectedIndex) item.setAttribute('aria-selected', 'true');
                item.textContent = opt.textContent;
                item.addEventListener('click', () => {
                    if (opt.disabled) return;
                    select.value = opt.value;
                    select.dispatchEvent(new Event('change'));
                    wrapper.querySelector('.select-label').textContent = opt.textContent;
                    menu.querySelectorAll('.select-option[aria-selected="true"]').forEach(n => n.removeAttribute('aria-selected'));
                    item.setAttribute('aria-selected', 'true');
                    wrapper.classList.remove('open');
                    trigger.setAttribute('aria-expanded', 'false');
                });
                menu.appendChild(item);
            });

            wrapper.appendChild(menu);

            // Events
            trigger.addEventListener('click', () => {
                const open = wrapper.classList.toggle('open');
                trigger.setAttribute('aria-expanded', String(open));
            });

            document.addEventListener('click', (e) => {
                if (!wrapper.contains(e.target)) {
                    wrapper.classList.remove('open');
                    trigger.setAttribute('aria-expanded', 'false');
                }
            });

            // Sync if select changes programmatically
            select.addEventListener('change', () => {
                const txt = getSelectedText();
                const label = wrapper.querySelector('.select-label');
                if (label) label.textContent = txt;
                menu.querySelectorAll('.select-option').forEach(optEl => {
                    optEl.toggleAttribute('aria-selected', optEl.dataset.value === select.value);
                });
            });
        } catch (e) {
            // eslint-disable-next-line no-console
            console.error('Gagal enhance select:', e);
            // Fallback: show native select
            select.classList.remove('select-native-hidden');
            const wrapper = select.closest('.select-wrapper');
            if (wrapper) wrapper.classList.remove('is-enhanced');
        }
    }
    // --- End custom dropdown helpers ---

    function updateMetricSelector(datasetKey) {
        const config = datasetsConfig[datasetKey];
        metricSelector.innerHTML = '';
        for (const [value, details] of Object.entries(config.metrics)) {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = details.label;
            option.dataset.label = details.label;
            metricSelector.appendChild(option);
        }
        // Rebuild enhanced dropdown for metric
        enhanceSelect(metricSelector);
    }

    async function loadDataset(datasetKey) {
        try {
            state.currentApiData = await fetchApiData(datasetsConfig[datasetKey].endpoint);
        } catch (err) {
            // eslint-disable-next-line no-console
            console.error('Gagal memuat data API:', err);
            container.innerHTML = `<p style="color:red; text-align:center;">Gagal memuat data.</p>`;
        }
    }

    function renderMap() {
        if (!state.currentApiData || !state.mapData) return;
        const datasetKey = datasetSelector.value;
        const selectedMetric = metricSelector.value;
        const config = datasetsConfig[datasetKey];
        const metricDetails = config.metrics[selectedMetric];

        const common = {
            mapData: state.mapData,
            currentApiData: state.currentApiData,
            config,
            metricDetails,
            reverseNameMapping,
            selectedMetric,
            datasetKey,
            containerId: 'container'
        };

        if (metricDetails.vizType === 'pattern') {
            renderPatternMap(common);
        } else {
            renderChoroplethMap(common);
        }
    }

    async function initializeApp() {
        try {
            state.mapData = await fetchGeoJSON(GEOJSON_URL);
            // Enhance dataset selector first (static options)
            enhanceSelect(datasetSelector);

            datasetSelector.addEventListener('change', async () => {
                const selectedDataset = datasetSelector.value;
                updateMetricSelector(selectedDataset);
                await loadDataset(selectedDataset);
                renderMap();
            });

            metricSelector.addEventListener('change', renderMap);

            const initialDataset = datasetSelector.value;
            updateMetricSelector(initialDataset);
            await loadDataset(initialDataset);
            renderMap();

            // Enhance both selects initially
            enhanceSelect(datasetSelector);
            enhanceSelect(metricSelector);

        } catch (error) {
            // eslint-disable-next-line no-console
            console.error('Inisialisasi aplikasi gagal:', error);
            container.innerHTML = `<p style="color:red; text-align:center;">Gagal memuat peta atau data awal.</p>`;
        }
    }

    initializeApp();
});


--- test-indonesia-map/regional_app/static/css/styles.css ---

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    margin: 0;
    padding: 0;
    background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    min-height: 100vh;
    position: relative;
    overflow-x: hidden;
}

.background-gradient {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background:
        radial-gradient(circle at 20% 50%, rgba(168, 237, 234, 0.5), transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(254, 214, 227, 0.5), transparent 50%),
        linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    z-index: -1;
}

.header {
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.5);
    padding: 2rem 1.5rem;
    margin-bottom: 2rem;
}

.header-content {
    max-width: 1400px;
    margin: 0 auto;
}

.header-title h1 {
    font-size: 2.5rem;
    font-weight: 700;
    color: #2d3748;
    margin-bottom: 0.5rem;
    letter-spacing: -0.5px;
    animation: fadeInDown 0.6s ease-out;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.header-subtitle {
    font-size: 1.1rem;
    color: #4a5568;
    font-weight: 400;
    animation: fadeInDown 0.6s ease-out 0.1s both;
}

.main-content {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 1.5rem 2rem;
}

.map-card {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 1.5rem;
    box-shadow:
        0 20px 60px rgba(102, 126, 234, 0.18),
        0 8px 24px rgba(102, 126, 234, 0.12);
    border: 2px solid rgba(255, 255, 255, 0.8);
    animation: fadeInUp 0.6s ease-out 0.3s both;
    overflow: hidden;
    position: relative;
}

.controls-overlay {
    position: absolute;
    top: 1.5rem;
    left: 1.5rem;
    z-index: 10;
    animation: fadeInDown 0.6s ease-out 0.4s both;
}

.controls-container {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    justify-content: flex-start;
}

.control-group {
    display: flex;
    flex-direction: column;
    gap: 0;
    min-width: auto;
}

.control-group label {
    font-size: 0.95rem;
    font-weight: 600;
    color: #2d3748;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.icon {
    color: #5a67d8;
}

.control-group select {
    padding: 0.625rem 0.875rem;
    font-size: 0.875rem;
    font-family: inherit;
    font-weight: 500;
    border-radius: 10px;
    border: 2px solid rgba(203, 213, 224, 0.6);
    background: rgba(255, 255, 255, 0.95);
    color: #2d3748;
    cursor: pointer;
    transition: border-color .2s ease, box-shadow .2s ease, transform .05s ease;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%235a67d8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.5rem center;
    background-size: 1rem;
    padding-right: 2rem;
    min-width: 200px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.control-group select:active {
    transform: scale(0.995);
}

.control-group select:disabled {
    opacity: .7;
    cursor: not-allowed;
}

/* Dropdown options styling (browser support may vary) */
.control-group select option {
    padding: .5rem .75rem;
    background: #ffffff;
    color: #2d3748;
    font-size: 0.875rem;
}

.control-group select option:hover {
    background: #667eea;
    color: #ffffff;
}

.control-group select option:checked {
    background: #3b5bdb;
    /* selected row color */
    color: #ffffff;
    font-weight: 600;
}

.control-group select option[disabled] {
    color: #a0aec0;
    background: #f7fafc;
}

/* Focus outline refinement */
.control-group select:focus-visible {
    outline: none;
    border-color: #5a67d8;
    box-shadow: 0 0 0 4px rgba(90, 103, 216, 0.25), 0 4px 14px rgba(0, 0, 0, 0.08);
}

/* Optional: smoother look on macOS/Chrome */
@supports (scrollbar-color: auto) {
    .control-group select {
        scrollbar-color: #cbd5e0 #edf2f7;
        scrollbar-width: thin;
    }
}

.controls-card {
    display: none;
}

#container {
    width: 100%;
    height: 750px;
    border-radius: 12px;
    overflow: hidden;
}

@keyframes fadeInDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive Design */
@media (max-width: 768px) {
    .header {
        padding: 1.5rem 1rem;
    }

    .header-title h1 {
        font-size: 1.75rem;
    }

    .header-subtitle {
        font-size: 0.95rem;
    }

    .main-content {
        padding: 0 1rem 1.5rem;
    }

    .controls-overlay {
        position: static;
        margin-bottom: 1rem;
    }

    .controls-container {
        flex-direction: column;
        gap: 0.5rem;
    }

    .control-group select {
        width: 100%;
        min-width: auto;
    }

    .map-card {
        padding: 1rem;
        border-radius: 16px;
    }

    #container {
        height: 500px;
    }
}

/* Dark mode support - disabled for bright theme */
@media (prefers-color-scheme: dark) {

    .map-card {
        background: rgba(255, 255, 255, 0.9);
    }

    .control-group label {
        color: #2d3748;
    }

    .control-group select {
        background: rgba(255, 255, 255, 0.95);
        color: #2d3748;
        border-color: rgba(203, 213, 224, 0.6);
    }

    .control-group select:hover {
        border-color: #5a67d8;
        background: white;
    }
}

.select-wrapper {
    position: relative;
    display: inline-block;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.95);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    transition: box-shadow .2s ease, border-color .2s ease;
    z-index: 30;
}

/* Hide native select when enhanced and keep it for accessibility */
.select-wrapper.is-enhanced select.select-native-hidden {
    position: absolute;
    inset: 0;
    opacity: 0;
    pointer-events: none;
    width: 100%;
    height: 100%;
}

/* Remove native arrow when enhanced */
.select-wrapper.is-enhanced select {
    background-image: none;
}

/* Trigger */
.custom-select {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    width: 100%;
    padding: 0.625rem 0.875rem;
    border: 2px solid rgba(203, 213, 224, 0.6);
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.95);
    color: #2d3748;
    font-size: 0.9rem;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    cursor: pointer;
    transition: border-color .2s ease, box-shadow .2s ease, transform .05s ease;
}

.custom-select:hover {
    border-color: #5a67d8;
    box-shadow: 0 0 0 3px rgba(90, 103, 216, 0.15), 0 2px 8px rgba(0, 0, 0, 0.08);
    background: #fff;
}

.select-wrapper.open .custom-select {
    box-shadow: 0 0 0 4px rgba(90, 103, 216, 0.25), 0 4px 14px rgba(0, 0, 0, 0.1);
    border-color: #5a67d8;
}

/* Caret */
.select-caret {
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-top: 6px solid #5a67d8;
    transition: transform .2s ease;
}

.select-wrapper.open .select-caret {
    transform: rotate(180deg);
}

/* Floating menu */
.select-menu {
    position: absolute;
    left: 0;
    top: calc(100% + 8px);
    min-width: 100%;
    max-height: 320px;
    overflow: auto;
    padding: 8px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 16px 40px rgba(102, 126, 234, .18), 0 6px 18px rgba(102, 126, 234, .12);
    border: 1px solid #e2e8f0;
    display: none;
    z-index: 100;
}

.select-wrapper.open .select-menu {
    display: block;
}

/* Menu item */
.select-option {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: 10px;
    color: #2d3748;
    font-weight: 500;
    cursor: pointer;
    transition: background .15s ease, color .15s ease;
}

.select-option:hover {
    background: #eef2ff;
    color: #1a237e;
}

.select-option[aria-selected="true"] {
    background: #e0e7ff;
    color: #1a237e;
    font-weight: 700;
}

.select-option[aria-disabled="true"] {
    opacity: .5;
    cursor: not-allowed;
}

/* Optional: when open add higher z-index to wrapper */
.select-wrapper.open {
    z-index: 120;
}

--- test-indonesia-map/regional_app/app.py ---

import pandas as pd
from flask import Flask, jsonify, render_template
import numpy as np

app = Flask(__name__)


# --- Fungsi untuk Dataset Indikator Ekonomi Regional ---
def clean_regional_data(df):
    df = df.rename(
        columns={
            "Provinsi": "provinsi",
            "Jumlah Rekening Penerima Pinjaman Aktif (entitas)": "rekening_penerima_aktif",
            "Jumlah Dana yang Diberikan (Rp miliar)": "dana_diberikan_miliar",
            "Jumlah Rekening Pemberi Pinjaman (akun)": "rekening_pemberi",
            "TWP 90%": "twp_90",
            "Jumlah Penerima Pinjaman (akun)": "jumlah_penerima",
            "Outstanding Pinjaman (Rp miliar)": "outstanding_pinjaman_miliar",
            "Jumlah Penduduk (Ribu)": "jumlah_penduduk_ribu",
            "PDRB (Ribu Rp)": "pdrb_ribu_rp",
            "Urbanisasi (%)": "urbanisasi_persen",
        }
    )

    numeric_cols = [
        "rekening_penerima_aktif",
        "dana_diberikan_miliar",
        "rekening_pemberi",
        "twp_90",
        "jumlah_penerima",
        "outstanding_pinjaman_miliar",
        "jumlah_penduduk_ribu",
        "pdrb_ribu_rp",
        "urbanisasi_persen",
    ]

    for col in numeric_cols:
        df[col] = df[col].replace("-", pd.NA)
        if df[col].dtype == "object":
            df[col] = df[col].str.replace(".", "", regex=False)
            df[col] = df[col].str.replace("%", "", regex=False)
            df[col] = df[col].str.replace(",", ".", regex=False)
        df[col] = pd.to_numeric(df[col], errors="coerce")

    return df


# --- Fungsi untuk Dataset Profil Finansial Gen Z ---
def clean_and_aggregate_financial_data(df):
    """Membersihkan dan mengagregasi data profil finansial per provinsi."""
    numeric_cols = [
        "avg_monthly_income (INT)",
        "avg_monthly_expense (INT)",
        "financial_anxiety_score",
        "digital_time_spent_per_day",
    ]
    for col in numeric_cols:
        df[col] = pd.to_numeric(df[col], errors="coerce")

    # Agregasi: mean untuk numerik, mode untuk kategorikal
    agg_functions = {
        "avg_monthly_income (INT)": "mean",
        "avg_monthly_expense (INT)": "mean",
        "financial_anxiety_score": "mean",
        "digital_time_spent_per_day": "mean",
        "main_fintech_app": lambda x: x.mode().iloc[0] if not x.mode().empty else None,
        "investment_type": lambda x: x.mode().iloc[0] if not x.mode().empty else None,
    }

    agg_df = df.groupby("province").agg(agg_functions).reset_index()

    # Hitung persentase pengguna untuk fintech app yang paling populer
    fintech_percentage = []
    for province in agg_df["province"]:
        province_data = df[df["province"] == province]
        if len(province_data) > 0:
            most_popular_app = (
                province_data["main_fintech_app"].mode().iloc[0]
                if not province_data["main_fintech_app"].mode().empty
                else None
            )
            if most_popular_app:
                percentage = (
                    (province_data["main_fintech_app"] == most_popular_app).sum()
                    / len(province_data)
                    * 100
                )
                fintech_percentage.append(round(percentage, 1))
            else:
                fintech_percentage.append(0)
        else:
            fintech_percentage.append(0)

    agg_df["fintech_percentage"] = fintech_percentage

    # Ganti nama kolom agar lebih mudah digunakan di frontend
    agg_df = agg_df.rename(
        columns={
            "province": "provinsi",
            "avg_monthly_income (INT)": "avg_income",
            "avg_monthly_expense (INT)": "avg_expense",
            "financial_anxiety_score": "avg_anxiety_score",
            "digital_time_spent_per_day": "avg_digital_time",
            "main_fintech_app": "mode_fintech_app",
            "investment_type": "mode_investment_type",
        }
    )

    # --- PERUBAHAN DI SINI ---
    # Hitung kolom baru untuk surplus/defisit
    agg_df["financial_balance"] = agg_df["avg_income"] - agg_df["avg_expense"]
    # --- AKHIR PERUBAHAN ---

    # Bulatkan nilai numerik
    # Tambahkan 'financial_balance' ke daftar kolom yang akan dibulatkan
    for col in [
        "avg_income",
        "avg_expense",
        "avg_anxiety_score",
        "avg_digital_time",
        "financial_balance",
    ]:
        agg_df[col] = agg_df[col].round(2)

    return agg_df


@app.route("/")
def index():
    return render_template("index.html")


@app.route("/api/data")
def get_regional_data():
    """Endpoint untuk data indikator ekonomi regional."""
    try:
        df = pd.read_csv("Dataset Gelarrasa - Regional_Economic_Indicators.csv")
        df_cleaned = clean_regional_data(df)
        df_final = df_cleaned.replace({np.nan: None})
        return jsonify(df_final.to_dict(orient="records"))
    except FileNotFoundError:
        return (
            jsonify({"error": "File Regional_Economic_Indicators.csv tidak ditemukan"}),
            404,
        )
    except Exception as e:
        return jsonify({"error": str(e)}), 500


@app.route("/api/financial-profile")
def get_financial_data():
    """Endpoint untuk data profil finansial Gen Z yang sudah diagregasi."""
    try:
        df = pd.read_csv("Dataset Gelarrasa - GenZ_Financial_Profile.csv")
        df_agg = clean_and_aggregate_financial_data(df)
        df_final = df_agg.replace({np.nan: None})
        return jsonify(df_final.to_dict(orient="records"))
    except FileNotFoundError:
        return (
            jsonify({"error": "File GenZ_Financial_Profile.csv tidak ditemukan"}),
            404,
        )
    except Exception as e:
        return jsonify({"error": str(e)}), 500


if __name__ == "__main__":
    app.run(debug=True)


--- test-indonesia-map/regional_app/templates/index.html ---

<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta Data Regional Indonesia</title>
    <link rel="stylesheet" href="/static/css/styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="background-gradient"></div>

    <header class="header">
        <div class="header-content">
            <div class="header-title">
                <h1>ðŸ“Š Visualisasi Data Regional Indonesia</h1>
                <p class="header-subtitle">Eksplorasi data ekonomi dan finansial Gen Z di seluruh provinsi</p>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="map-card">
            <div class="controls-overlay">
                <div class="controls-container">
                    <div class="control-group">
                        <div class="select-wrapper">
                            <select id="dataset-selector">
                                <option value="regional">Indikator Ekonomi Regional</option>
                                <option value="financial">Profil Finansial Gen Z</option>
                            </select>
                        </div>
                    </div>
                    <div class="control-group">
                        <div class="select-wrapper">
                            <select id="metric-selector">
                                <!-- Opsi akan diisi oleh JavaScript -->
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div id="container"></div>
        </div>
    </main>

    <script src="https://code.highcharts.com/maps/highmaps.js"></script>
    <script src="https://code.highcharts.com/maps/modules/exporting.js"></script>
    <script type="module" src="/static/js/app.js"></script>
</body>

</html>